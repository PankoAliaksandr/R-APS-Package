# This file is modified by Aliaksandr Panko (PAA) 11.02.20
# Bugs with -Inf have been fixed


library(pdftools)

# Set digits length for "as.numeric" function
options(digits=9)

# Check all folders within the parent directory:
dir <- list.dirs(path = "L:/FAP/Manager Selection/Portfolios/Passive Produkte/BlackRock/Global and Country EM/Monitoring/MSCI Factsheet",
                 full.names = TRUE,
                 recursive = TRUE)

# Get all files within the directory:
files <-  list.files(path = max(dir),
                     full.names = TRUE,
                     recursive = TRUE)

# To check if files are of the right type
num_pdf_files <- length(grep(pattern = ".pdf",x = files))
num_all_files <- length(files)

if(num_pdf_files == num_all_files){
  # This means there are only .pdf files (required for pdf_text function)
  # Set list to record data:
  output <- list(Index = NULL, Date = NULL, MktCap = NULL)

  for (i in 1:length(files)){
    # Read pdf file:
    text <- pdf_text(files[i])
    # Remove spaces:
    text2 <- gsub("  ","",text)
    # Split text at "\r\n" tags:
    text3 <- strsplit(text2, "\r\n")
    # Supstitute "," with blanks for numeric values in Line 8 page 2:
    # Line number depends of pdf format for 02.20 line is 9
    line8page2 <- text3[[2]][9]
    # Substitute all letters with space
    l8p2_num_only <- gsub(pattern = "([[:alpha:]])", replacement = " ", x = line8page2)
    # from many space make only single space (however traling and leading are still present)
    l8p2_single_spaces <- gsub(pattern = "\\s+", replacement = " ", x = l8p2_num_only)
    # Delete traling and leading spaces
    l8p2_single_space <- trimws(l8p2_single_spaces)
    # there should not be any "," in a number. (thousands should not be separated)
    l8p2_correct_numbers <- gsub(pattern = ",", replacement = "", x = l8p2_single_space)
    # Get only numbers
    char_vector <- strsplit(x = l8p2_correct_numbers, split = " ")[[1]]
    # Convert character "numbers" to actual numbers
    # we do not need worings here, they are expected
    num_vector <- suppressWarnings(as.numeric(char_vector))
    # Remove NA
    num_vector <- num_vector[!is.na(num_vector)]
    # The market cap should be the first number in a vector
    requited_number <- num_vector[1]
    output$MktCap[i] <- requited_number
    # # Catch Index name:
    output$Index[i] <- text3[[1]][1]
    #Catch data:
    output$Date[i] <- text3[[2]][1]
  }
  # Write the data in a csv file:
  write.table(as.data.frame(output), file = paste0(max(dir),"/indexData.csv"), sep=";", row.names = F)
  cat("The output document is completed successfully!")
}else{
  stop("There are non-pdf files in the folder. Please remove them (check indexData.csv) and try again")
}
